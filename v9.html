<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RVT Szolgálattervezet V9.0 - GitHub Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Verdana', sans-serif; font-size: 0.85rem; }
        .header-bg { background-color: #24292e; color: white; padding: 15px 0; border-bottom: 4px solid #2dba4e; } /* GitHub colors */
        
        .gun-icon { margin-right: 10px; vertical-align: middle; color: #fff; }
        .gun-icon-login { color: #24292e; margin-bottom: 15px; }
        .gun-icon-print { color: #000; margin-right: 15px; vertical-align: middle; }

        .roster-table th, .roster-table td { text-align: center; vertical-align: middle; padding: 4px 2px; white-space: nowrap; border: 1px solid #dee2e6; }
        .roster-table th { background-color: #343a40; color: white; font-size: 0.75rem; }
        .clickable-header { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
        .clickable-header:hover { color: #ffc107; }
        .roster-cell { cursor: pointer; height: 35px; min-width: 45px; font-size: 0.75rem; }
        .roster-cell:hover { border: 2px solid #0d6efd; z-index: 10; }

        .th-sat { background-color: #d1e7dd !important; color: #0f5132 !important; } 
        .th-sun { background-color: #f8d7da !important; color: #842029 !important; } 
        .th-hol { background-color: #dc3545 !important; color: white !important; border-color: #b02a37; } 
        .cell-pn, .cell-pi { background-color: #e2e3e5; color: #6c757d; }
        .cell-x { background-color: #fff3cd; color: #856404; font-weight: bold; }
        .cell-b { background-color: #f8d7da; color: #721c24; font-weight: bold; }
        .cell-tm { background-color: #d1e7dd; color: #0f5132; font-weight: bold; }
        .hour-under { background-color: #fff3cd; color: #856404; font-weight: bold; } 
        .hour-ok { background-color: #d1e7dd; color: #0f5132; font-weight: bold; } 
        .hour-over { background-color: #f8d7da; color: #842029; font-weight: bold; } 
        .name-col { text-align: left !important; padding-left: 8px !important; font-weight: bold; position: sticky; left: 0; background: white; z-index: 5; min-width: 150px; border-right: 2px solid #ccc; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(36, 41, 46, 0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 8px; width: 450px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        #loadingOverlay { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); z-index: 10000; justify-content: center; align-items: center; flex-direction: column; }
        
        #printHeader { display: none; }
        .print-hidden-row { display: none !important; } 
        .hidden-perm { display: none !important; }
        @media print {
            @page { size: A3 landscape; margin: 5mm; }
            #mainApp > .header-bg, #loginOverlay, .no-print, .nav-tabs, #alertPlace, .modal, #loadingOverlay { display: none !important; }
            .tab-content > .tab-pane { display: none !important; }
            .tab-content > .active { display: block !important; }
            #printHeader { display: block; margin-bottom: 10px; text-align: center; }
            #printTitle { font-size: 24px; font-weight: bold; margin: 0; }
            .card { border: none !important; box-shadow: none !important; }
            body { background-color: white; -webkit-print-color-adjust: exact; zoom: 95%; font-family: 'Verdana', sans-serif; }
            .roster-table { width: 100%; border-collapse: collapse; }
            .roster-table th, .roster-table td { border: 1px solid #000 !important; font-size: 9px !important; padding: 1px !important; height: 25px !important; }
            .name-col { min-width: 120px !important; }
            .th-sat, .th-sun, .th-hol, .cell-x, .cell-b, .cell-tm { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="mt-2 fw-bold text-success">Szinkronizálás (GitHub + Cloud)...</div>
    </div>

    <div id="loginOverlay">
        <div class="login-box">
            <i class="fa-solid fa-gun fa-4x gun-icon-login"></i>
            <h3 class="mb-4 fw-bold" style="color: #24292e; font-family: 'Verdana', sans-serif;">RVT Szolgálattervezet</h3>
            
            <div class="alert alert-secondary small text-start">
                <i class="fa-brands fa-github"></i> <b>GitHub Edition:</b> A program a weben fut, az adatok a felhőben (JSONBin).
            </div>

            <input type="text" class="form-control mb-2" id="loginUser" placeholder="Felhasználónév">
            <input type="password" class="form-control mb-3" id="loginPass" placeholder="Jelszó">
            <button class="btn btn-success w-100 fw-bold" onclick="performLogin()">Belépés</button>
        </div>
    </div>

    <div id="mainApp" style="display:none;">
        <div class="header-bg no-print">
            <div class="container-fluid px-4 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-gun fa-2x gun-icon"></i>
                    <h4 class="m-0 fw-bold">RVT Szolgálattervezet</h4>
                    
                    <div class="d-flex align-items-center gap-2 ms-4">
                        <select id="selYear" class="form-select form-select-sm w-auto" onchange="changePeriod()"></select>
                        <select id="selMonth" class="form-select form-select-sm w-auto" onchange="changePeriod()">
                            <option value="0">Január</option><option value="1">Február</option><option value="2">Március</option>
                            <option value="3">Április</option><option value="4">Május</option><option value="5">Június</option>
                            <option value="6">Július</option><option value="7">Augusztus</option><option value="8">Szeptember</option>
                            <option value="9">Október</option><option value="10">November</option><option value="11">December</option>
                        </select>
                    </div>
                </div>
                <div>
                    <span class="me-3 fw-bold" id="userInfo"></span>
                    <button class="btn btn-sm btn-light text-danger fw-bold" onclick="performLogout()"><i class="fa-solid fa-power-off"></i> Kilépés</button>
                </div>
            </div>
        </div>

        <div class="container-fluid mt-3">
            <div id="alertPlace"></div>

            <ul class="nav nav-tabs mb-3 no-print" id="mainTab" role="tablist">
                <li class="nav-item"><button class="nav-link active fw-bold text-dark" data-bs-target="#tab-roster" data-bs-toggle="tab"><i class="fa-solid fa-table"></i> Vezénylés (Naptár)</button></li>
                <li class="nav-item admin-only"><button class="nav-link text-primary fw-bold" data-bs-target="#tab-batch" data-bs-toggle="tab"><i class="fa-solid fa-layer-group"></i> Csoportos Rögzítés</button></li>
                <li class="nav-item admin-only"><button class="nav-link text-danger fw-bold" data-bs-target="#tab-users" data-bs-toggle="tab"><i class="fa-solid fa-user-lock"></i> Jogosultságok & Jelszavak</button></li>
                <li class="nav-item admin-only"><button class="nav-link text-secondary fw-bold" data-bs-target="#tab-settings" data-bs-toggle="tab"><i class="fa-solid fa-calendar-check"></i> Havi Beállítások</button></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-roster">
                    <div id="printHeader">
                        <i class="fa-solid fa-gun fa-2x gun-icon-print"></i>
                        <h2 id="printTitle" style="display:inline-block; vertical-align:middle;">RVT SZOLGÁLATTERVEZET</h2>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2 no-print">
                        <div class="text-muted small align-self-end"><i class="fa-solid fa-cloud"></i> Az adatok biztonságos felhőben tárolódnak.</div>
                        <div class="btn-group">
                             <button class="btn btn-dark btn-sm ms-2" onclick="openPrintModal()"><i class="fa-solid fa-print"></i> Nyomtatás...</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm roster-table mb-0" id="mainRosterTable">
                                    <thead id="rosterHead"></thead>
                                    <tbody id="rosterBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-batch">
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white fw-bold">Csoportos / Több napos rögzítés</div>
                                <div class="card-body">
                                    <label class="form-label fw-bold">1. Kinek?</label>
                                    <select class="form-select mb-3" id="batchUserSelect"></select>
                                    <label class="form-label fw-bold">2. Mettől - Meddig?</label>
                                    <div class="row g-2 mb-3">
                                        <div class="col-6"><input type="number" class="form-control" id="batchStartDay" placeholder="Kezdő nap" min="1" max="31"></div>
                                        <div class="col-6"><input type="number" class="form-control" id="batchEndDay" placeholder="Vég nap" min="1" max="31"></div>
                                    </div>
                                    <label class="form-label fw-bold">3. Mit?</label>
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-4">
                                            <select class="form-select" id="batchType" onchange="toggleBatchTime()">
                                                <option value="WORK">Szolgálat</option>
                                                <option value="X">Szabadság</option>
                                                <option value="B">Beteg</option>
                                                <option value="PI">Pihenőidő</option>
                                                <option value="PN">Pihenőnap</option>
                                                <option value="TM">Megváltás</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8" id="batchTimeInputs">
                                            <div class="input-group">
                                                <span class="input-group-text">Idő</span>
                                                <input type="time" class="form-control" id="batchStartTime" value="07:00">
                                                <span class="input-group-text">-</span>
                                                <input type="time" class="form-control" id="batchEndTime" value="15:30">
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary w-100 fw-bold" onclick="applyBatch()">RÖGZÍTÉS</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-users">
                     <div class="card border-danger">
                        <div class="card-header bg-danger text-white fw-bold">Felhasználók & Jogosultságok</div>
                        <div class="card-body">
                            <div class="row g-2 mb-4 align-items-end">
                                <div class="col-md-3"><input type="text" class="form-control" id="newUserName" placeholder="Név"></div>
                                <div class="col-md-2"><input type="text" class="form-control" id="newUserLogin" placeholder="Login"></div>
                                <div class="col-md-2"><input type="text" class="form-control" id="newUserPass" placeholder="Jelszó"></div>
                                <div class="col-md-2">
                                    <select class="form-select" id="newUserRole">
                                        <option value="USER">User</option>
                                        <option value="ADMIN">ADMIN</option>
                                    </select>
                                </div>
                                <div class="col-md-3"><button class="btn btn-success w-100" onclick="addNewUser()">Létrehozás</button></div>
                            </div>
                            <table class="table table-striped table-hover align-middle"><thead class="table-dark"><tr><th>Név</th><th>Login</th><th>Jelszó</th><th>Jogkör</th><th>Egyenleg</th><th></th></tr></thead><tbody id="userSettingsTable"></tbody></table>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-settings">
                     <div class="card h-100 border-warning">
                        <div class="card-header bg-warning text-dark fw-bold">Havi Beállítások</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6"><div class="mb-3"><label class="form-label fw-bold">Havi Norma:</label><div class="input-group"><input type="number" class="form-control" id="configNorma"><button class="btn btn-outline-secondary" onclick="calculateNormaForUI()"><i class="fa-solid fa-rotate-right"></i></button></div></div></div>
                                <div class="col-md-6">
                                    <div class="mb-3"><label class="form-label fw-bold text-danger">Ünnepnapok:</label><input type="text" class="form-control" id="configHolidays"></div>
                                    <div class="mb-3"><label class="form-label fw-bold text-success">Ledolgozós Hétvégék:</label><input type="text" class="form-control" id="configWorkWeekends"></div>
                                </div>
                            </div>
                            <button class="btn btn-warning w-100 fw-bold" onclick="saveMonthConfig()">Mentés</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Napi Beosztás</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="editUserId"><input type="hidden" id="editDay"><div class="row g-1 mb-3"><div class="col-4"><input type="radio" class="btn-check" name="sType" id="stWork" value="WORK" checked onchange="toggleModalFields()"><label class="btn btn-outline-secondary w-100" for="stWork">Szolg.</label></div><div class="col-4"><input type="radio" class="btn-check" name="sType" id="stPI" value="PI" onchange="toggleModalFields()"><label class="btn btn-outline-secondary w-100" for="stPI">PI</label></div><div class="col-4"><input type="radio" class="btn-check" name="sType" id="stPN" value="PN" onchange="toggleModalFields()"><label class="btn btn-outline-secondary w-100" for="stPN">PN</label></div><div class="col-4"><input type="radio" class="btn-check" name="sType" id="stX" value="X" onchange="toggleModalFields()"><label class="btn btn-outline-warning text-dark w-100" for="stX">Szabi</label></div><div class="col-4"><input type="radio" class="btn-check" name="sType" id="stB" value="B" onchange="toggleModalFields()"><label class="btn btn-outline-danger w-100" for="stB">Beteg</label></div><div class="col-4"><input type="radio" class="btn-check" name="sType" id="stTM" value="TM" onchange="toggleModalFields()"><label class="btn btn-outline-success w-100" for="stTM">TM</label></div></div><div id="timeFields"><div class="row g-2 mb-2"><div class="col-6"><label>Kezdés:</label><input type="time" class="form-control" id="startTime" onchange="calcHours()"></div><div class="col-6"><label>Vége:</label><input type="time" class="form-control" id="endTime" onchange="calcHours()"></div></div></div><div class="row g-2 mb-3"><div class="col-6"><label>Elszámolt Óra:</label><input type="number" class="form-control" id="calcHours" step="0.5"></div><div class="col-6"><label class=\"text-primary\">Túlszolgálat (+):</label><input type="number" class="form-control border-primary" id="overtimeVal" step="0.5"></div></div><button class="btn btn-success w-100 fw-bold" onclick="saveEntry()">MENTÉS</button><button class="btn btn-outline-danger w-100 mt-2" onclick="deleteEntry()">Törlés</button></div></div></div></div>
    <div class="modal fade" id="colBatchModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Napi Csoportos</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="colBatchDay"><label class="fw-bold mb-2">Mit rögzítsünk mindenkinek?</label><div class="row g-2 mb-3"><div class="col-md-5"><select class="form-select" id="colBatchType" onchange="toggleColBatchTime()"><option value="WORK">Szolgálat</option><option value="X">Szabadság</option><option value="PN">Pihenőnap</option><option value="PI">Pihenőidő</option><option value="TM">Megváltás</option></select></div><div class="col-md-7" id="colBatchTimeDiv"><div class="input-group"><input type="time" class="form-control" id="colBatchStart" value="07:00"><span class="input-group-text">-</span><input type="time" class="form-control" id="colBatchEnd" value="15:30"></div></div></div><button class="btn btn-primary w-100" onclick="saveColBatch()">MINDENKI FRISSÍTÉSE</button></div></div></div></div>
    <div class="modal fade" id="printModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title">Nyomtatás</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="d-flex justify-content-between mb-2"><span>Kik?</span><button class="btn btn-sm btn-outline-secondary" onclick="toggleAllPrint(true)">Összes</button></div><div class="list-group" id="printUserList"></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="executePrint()">NYOMTATÁS</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==========================================
        // CONFIGURÁCIÓ (JSONBin.io)
        // IDE ILLESZD BE A KULCSOKAT!
        // ==========================================
        const CLOUD_CONFIG = {
            API_KEY: '$2a$10$..........................................', // X-Master-Key
            BIN_ID: '........................' // Bin ID
        };

        // --- DATA STATE ---
        let users = [
            { id: 1, name: "Admin Példa", login: "admin", pass: "1234", role: "ADMIN", balance: 0 },
            { id: 2, name: "Teszt János", login: "user1", pass: "1234", role: "USER", balance: 0 }
        ];
        let db = {}; 
        let configs = {}; 
        let currentUser = null;

        // --- INIT ---
        window.onload = function() {
            const y = new Date().getFullYear();
            const sY = document.getElementById("selYear");
            sY.innerHTML = "";
            for(let i=2023; i<=2030; i++) sY.innerHTML += `<option value="${i}" ${i===y?'selected':''}>${i}</option>`;
            document.getElementById("selMonth").value = new Date().getMonth();
            
            if(CLOUD_CONFIG.BIN_ID.includes('.')) {
                alert("FIGYELEM! A kódba be kell írnod a JSONBin API kulcsokat a működéshez!");
            }
        };

        // --- CLOUD FUNCTIONS ---
        async function loadFromCloud() {
            showLoading(true);
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.BIN_ID}`, {
                    method: 'GET',
                    headers: { 'X-Master-Key': CLOUD_CONFIG.API_KEY }
                });
                
                if (response.ok) {
                    const json = await response.json();
                    const data = json.record;
                    if(data.users) users = data.users;
                    if(data.db) db = data.db;
                    if(data.configs) configs = data.configs;
                }
            } catch (error) {
                alert("Hiba a betöltéskor: " + error);
            } finally {
                showLoading(false);
                refreshUI();
            }
        }

        async function saveToCloud() {
            showLoading(true);
            try {
                const dataToSave = { users, db, configs, lastUpdated: new Date().toISOString() };
                await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.BIN_ID}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Master-Key': CLOUD_CONFIG.API_KEY 
                    },
                    body: JSON.stringify(dataToSave)
                });
            } catch (error) {
                alert("Hiba a mentéskor: " + error);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById("loadingOverlay").style.display = show ? "flex" : "none";
        }

        function refreshUI() {
            calculateNormaForUI(true);
            loadConfigForPeriod();
            renderRoster();
            applyPermissions();
            renderSettings();
            renderBatchSelect();
        }

        // --- LOGIN ---
        function performLogin() {
            const u = document.getElementById("loginUser").value;
            const p = document.getElementById("loginPass").value;
            
            showLoading(true);
            fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.BIN_ID}`, {
                method: 'GET',
                headers: { 'X-Master-Key': CLOUD_CONFIG.API_KEY }
            }).then(res => res.json()).then(json => {
                const data = json.record;
                if(data.users) users = data.users; 
                if(data.db) db = data.db;
                if(data.configs) configs = data.configs;

                let found = users.find(x => x.login === u && x.pass === p);
                
                if (u === "admin" && p === "1234" && !found) {
                     currentUser = { id: 0, name: "Rendszer Admin", role: "ADMIN" }; found = true;
                } else if (found) { currentUser = found; }

                if(found) {
                    document.getElementById("loginOverlay").style.display = "none";
                    document.getElementById("mainApp").style.display = "block";
                    document.getElementById("userInfo").innerText = `Belépve: ${currentUser.name}`;
                    refreshUI();
                } else {
                    alert("Hibás felhasználónév vagy jelszó!");
                }
            }).catch(err => {
                alert("Hiba a felhő kapcsolatban: " + err);
            }).finally(() => showLoading(false));
        }

        function performLogout() { if(confirm("Kilépés?")) location.reload(); }

        function applyPermissions() {
            const isAdmin = currentUser && currentUser.role === "ADMIN";
            document.querySelectorAll(".admin-only").forEach(el => el.classList.toggle("hidden-perm", !isAdmin));
            document.querySelectorAll(".clickable-header").forEach(el => {
                el.style.pointerEvents = isAdmin ? "auto" : "none";
                el.title = isAdmin ? "Kattints csoportos rögzítéshez!" : "";
            });
        }

        // --- LOGIC ---
        function changePeriod() { refreshUI(); }
        function getKey() { return `${document.getElementById("selYear").value}-${parseInt(document.getElementById("selMonth").value)+1}`; }

        function calculateNorma(y, m, holidays, workWeekends) {
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            let workDays = 0;
            for(let d=1; d<=daysInMonth; d++) {
                const date = new Date(y, m, d);
                const day = date.getDay();
                const isW = (day===0||day===6);
                if (!holidays.includes(d) && (!isW || workWeekends.includes(d))) workDays++;
            }
            return workDays * 8;
        }
        function calculateNormaForUI() {
            const y = parseInt(document.getElementById("selYear").value);
            const m = parseInt(document.getElementById("selMonth").value);
            const h = document.getElementById("configHolidays").value.split(",").map(x=>parseInt(x)).filter(x=>!isNaN(x));
            const w = document.getElementById("configWorkWeekends").value.split(",").map(x=>parseInt(x)).filter(x=>!isNaN(x));
            document.getElementById("configNorma").value = calculateNorma(y, m, h, w);
        }

        // --- RENDER ---
        function renderRoster() {
            const y = parseInt(document.getElementById("selYear").value);
            const m = parseInt(document.getElementById("selMonth").value);
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const key = getKey();
            const monthData = db[key] || {};
            const conf = configs[key] || { norma: 168, holidays: [], workWeekends: [] };

            let hRow = `<tr><th class="name-col">Név / Nap</th>`;
            for (let i = 1; i <= daysInMonth; i++) {
                const d = new Date(y, m, i).getDay();
                let cls = "";
                if (conf.holidays.includes(i)) cls = "th-hol";
                else if (d===6 && !conf.workWeekends.includes(i)) cls = "th-sat";
                else if (d===0 && !conf.workWeekends.includes(i)) cls = "th-sun";
                hRow += `<th class="${cls} clickable-header" onclick="openColumnBatch(${i})">${i}.<br>${['V','H','K','S','C','P','S'][d]}</th>`;
            }
            hRow += `<th>Norma/Telj.</th><th>Egyenleg</th></tr>`;
            document.getElementById("rosterHead").innerHTML = hRow;
            document.getElementById("printTitle").innerText = `RVT SZOLGÁLATTERVEZET - ${y}. ${document.getElementById("selMonth").options[m].text}`;

            const tbody = document.getElementById("rosterBody");
            tbody.innerHTML = "";
            users.forEach(u => {
                let row = `<tr data-uid="${u.id}"><td class="name-col">${u.name}</td>`;
                let sum = 0, ot = 0;
                const uData = monthData[u.id] || {};
                
                for(let i=1; i<=daysInMonth; i++){
                    const e = uData[i];
                    let txt="", cls="";
                    if(e){
                        if(e.type==="WORK"){ txt=`${e.start}-${e.end}`; if(e.overtime>0) txt+=`<br><span class="text-danger">+${e.overtime}</span>`; sum+=e.hours; }
                        else if(e.type==="TM"){ txt="TM"; cls="cell-tm"; }
                        else { txt=e.type; if(e.type==="X")cls="cell-x"; if(e.type==="B")cls="cell-b"; if(e.type.startsWith("P"))cls="cell-pn"; if(["X","B"].includes(e.type)) sum+=e.hours; }
                        if(e.overtime) ot+=e.overtime;
                    }
                    row += `<td class="roster-cell ${cls}" onclick="openEdit(${u.id},${i})">${txt}</td>`;
                }
                
                let chg = ot;
                Object.values(uData).forEach(e=>{if(e.type==="TM")chg-=8;});
                const bal = (parseFloat(u.balance)||0) + chg;
                const norm = parseInt(conf.norma);
                const hCls = sum<norm?"hour-under":(sum>norm?"hour-over":"hour-ok");
                
                row += `<td class="${hCls}">${norm}/${sum}</td><td class="${bal<0?'text-danger':'text-success'} fw-bold">${bal}</td></tr>`;
                tbody.innerHTML += row;
            });
        }

        // --- EDIT ---
        function openEdit(uid, day) {
            const key = getKey();
            const existing = db[key]?.[uid]?.[day];
            if(currentUser.role !== "ADMIN") {
                if(uid !== currentUser.id) return alert("Csak a saját sorodat szerkesztheted!");
                if(existing) return alert("Már van rögzítve, csak Admin módosíthat!");
            }
            document.getElementById("editUserId").value = uid;
            document.getElementById("editDay").value = day;
            
            if(existing && existing.type==="WORK") {
                document.getElementById("startTime").value = existing.start;
                document.getElementById("endTime").value = existing.end;
                document.getElementById("stWork").checked = true;
            } else if(existing) {
                 document.querySelector(`input[name="sType"][value="${existing.type}"]`).checked = true;
            } else {
                document.getElementById("stWork").checked = true;
                document.getElementById("startTime").value = "07:00";
                document.getElementById("endTime").value = "15:30";
            }
            toggleModalFields();
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        function toggleModalFields() {
            const t = document.querySelector('input[name="sType"]:checked').value;
            const isW = t==="WORK";
            document.getElementById("timeFields").style.display = isW ? "block" : "none";
            document.getElementById("overtimeVal").disabled = (t==="B"||t==="TM");
            if(isW) calcHours();
            else {
                document.getElementById("calcHours").value = (t==="X"||t==="B") ? 8 : 0;
                if(!isW) document.getElementById("overtimeVal").value = 0;
            }
        }
        function calcHours() {
            const s = document.getElementById("startTime").value.split(":");
            const e = document.getElementById("endTime").value.split(":");
            let d = (parseInt(e[0])*60+parseInt(e[1]) - (parseInt(s[0])*60+parseInt(s[1])))/60;
            if(d<0) d+=24;
            document.getElementById("calcHours").value = d;
        }

        function saveEntry() {
            const uid = document.getElementById("editUserId").value;
            const day = document.getElementById("editDay").value;
            const key = getKey();
            if(!db[key]) db[key]={}; if(!db[key][uid]) db[key][uid]={};
            
            const t = document.querySelector('input[name="sType"]:checked').value;
            db[key][uid][day] = {
                type: t,
                start: t==="WORK"?document.getElementById("startTime").value:"",
                end: t==="WORK"?document.getElementById("endTime").value:"",
                hours: parseFloat(document.getElementById("calcHours").value)||0,
                overtime: parseFloat(document.getElementById("overtimeVal").value)||0
            };
            saveToCloud().then(()=>{ bootstrap.Modal.getInstance(document.getElementById('editModal')).hide(); refreshUI(); });
        }
        function deleteEntry() {
            if(currentUser.role!=="ADMIN") return alert("Csak Admin törölhet!");
            const uid = document.getElementById("editUserId").value;
            const day = document.getElementById("editDay").value;
            const key = getKey();
            if(db[key]?.[uid]) delete db[key][uid][day];
            saveToCloud().then(()=>{ bootstrap.Modal.getInstance(document.getElementById('editModal')).hide(); refreshUI(); });
        }

        // --- BATCH ---
        function renderBatchSelect() {
            const s = document.getElementById("batchUserSelect"); s.innerHTML=`<option value="ALL">-- MINDENKI --</option>`;
            users.forEach(u => s.innerHTML+=`<option value="${u.id}">${u.name}</option>`);
        }
        function openColumnBatch(d) {
             if(currentUser.role!=="ADMIN") return alert("Csak Admin!");
             document.getElementById("colBatchDay").value = d;
             new bootstrap.Modal(document.getElementById('colBatchModal')).show();
        }
        function toggleColBatchTime() {
             document.getElementById("colBatchTimeDiv").style.display = document.getElementById("colBatchType").value==="WORK"?"block":"none";
        }
        function toggleBatchTime() {
             document.getElementById("batchTimeInputs").style.display = document.getElementById("batchType").value==="WORK"?"block":"none";
        }
        function saveColBatch() {
             const d = document.getElementById("colBatchDay").value;
             const t = document.getElementById("colBatchType").value;
             const key = getKey();
             if(!db[key]) db[key]={};
             users.forEach(u => {
                 if(!db[key][u.id]) db[key][u.id]={};
                 let h = 0, s="", e="";
                 if(t==="WORK") {
                    s = document.getElementById("colBatchStart").value;
                    e = document.getElementById("colBatchEnd").value;
                    let sp=s.split(":"), ep=e.split(":");
                    h = (parseInt(ep[0])*60+parseInt(ep[1]) - (parseInt(sp[0])*60+parseInt(sp[1])))/60;
                    if(h<0) h+=24;
                 } else if (t==="X"||t==="B") h=8;
                 
                 db[key][u.id][d] = { type: t, start: s, end: e, hours: h, overtime: 0 };
             });
             saveToCloud().then(()=>{ bootstrap.Modal.getInstance(document.getElementById('colBatchModal')).hide(); refreshUI(); });
        }
        function applyBatch() {
            const uid = document.getElementById("batchUserSelect").value;
            const sd = parseInt(document.getElementById("batchStartDay").value);
            const ed = parseInt(document.getElementById("batchEndDay").value);
            const t = document.getElementById("batchType").value;
            const key = getKey();
            if(!db[key]) db[key]={};
            const targets = uid==="ALL" ? users : users.filter(u=>u.id==uid);
            
            targets.forEach(u => {
                 if(!db[key][u.id]) db[key][u.id]={};
                 for(let i=sd; i<=ed; i++) {
                     let h=0, s="", e="";
                     if(t==="WORK"){
                        s = document.getElementById("batchStartTime").value;
                        e = document.getElementById("batchEndTime").value;
                        let sp=s.split(":"), ep=e.split(":");
                        h = (parseInt(ep[0])*60+parseInt(ep[1]) - (parseInt(sp[0])*60+parseInt(sp[1])))/60;
                        if(h<0) h+=24;
                     } else if(t==="X"||t==="B") h=8;
                     db[key][u.id][i] = { type: t, start: s, end: e, hours: h, overtime: 0 };
                 }
            });
            saveToCloud().then(()=>{ refreshUI(); alert("Kész!"); });
        }

        // --- SETTINGS (ADMIN) ---
        function renderSettings() {
            const t = document.getElementById("userSettingsTable"); t.innerHTML="";
            users.forEach((u,i) => {
                t.innerHTML += `<tr><td><input class="form-control form-control-sm" value="${u.name}" onchange="updUser(${i},'name',this.value)"></td>
                <td><input class="form-control form-control-sm" value="${u.login}" onchange="updUser(${i},'login',this.value)"></td>
                <td><input class="form-control form-control-sm" value="${u.pass}" onchange="updUser(${i},'pass',this.value)"></td>
                <td><select class="form-select form-select-sm" onchange="updUser(${i},'role',this.value)"><option value="USER" ${u.role==='USER'?'selected':''}>User</option><option value="ADMIN" ${u.role==='ADMIN'?'selected':''}>Admin</option></select></td>
                <td><input type="number" class="form-control form-control-sm" style="width:70px" value="${u.balance}" onchange="updUser(${i},'balance',this.value)"></td>
                <td><button class="btn btn-sm btn-danger" onclick="delUser(${i})"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }
        function addNewUser() {
            users.push({ id: Date.now(), name: document.getElementById("newUserName").value, login: document.getElementById("newUserLogin").value, pass: document.getElementById("newUserPass").value, role: document.getElementById("newUserRole").value, balance: 0 });
            saveToCloud().then(refreshUI);
        }
        function updUser(i,f,v){ users[i][f]=v; saveToCloud(); }
        function delUser(i){ if(confirm("Törlés?")){ users.splice(i,1); saveToCloud().then(refreshUI); } }
        
        function loadConfigForPeriod() {
            const k = getKey();
            const c = configs[k] || { norma: null, holidays: [], workWeekends: [] };
            document.getElementById("configHolidays").value = c.holidays.join(",");
            document.getElementById("configWorkWeekends").value = c.workWeekends.join(",");
            if(c.norma) document.getElementById("configNorma").value = c.norma; else calculateNormaForUI();
        }
        function saveMonthConfig() {
            const k = getKey();
            configs[k] = {
                norma: parseInt(document.getElementById("configNorma").value),
                holidays: document.getElementById("configHolidays").value.split(",").map(x=>parseInt(x)).filter(x=>!isNaN(x)),
                workWeekends: document.getElementById("configWorkWeekends").value.split(",").map(x=>parseInt(x)).filter(x=>!isNaN(x))
            };
            saveToCloud().then(()=>{alert("Beállítások mentve!"); refreshUI();});
        }

        // --- PRINT ---
        function openPrintModal() {
            const l = document.getElementById("printUserList"); l.innerHTML="";
            users.forEach(u => l.innerHTML+=`<label class="list-group-item"><input class="form-check-input me-1 print-check" type="checkbox" value="${u.id}" checked>${u.name}</label>`);
            new bootstrap.Modal(document.getElementById('printModal')).show();
        }
        function toggleAllPrint(s) { document.querySelectorAll(".print-check").forEach(c=>c.checked=true); }
        function executePrint() {
            const s = Array.from(document.querySelectorAll(".print-check:checked")).map(c=>c.value);
            const rows = document.querySelectorAll("#mainRosterTable tbody tr");
            rows.forEach(r => r.classList.toggle("print-hidden-row", !s.includes(r.getAttribute("data-uid"))));
            bootstrap.Modal.getInstance(document.getElementById('printModal')).hide();
            setTimeout(() => { window.print(); setTimeout(()=>rows.forEach(r=>r.classList.remove("print-hidden-row")),500); }, 500);
        }
    </script>
</body>
</html>